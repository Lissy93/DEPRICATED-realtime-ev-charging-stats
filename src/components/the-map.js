import React, { Component } from "react";
import Link from 'gatsby-link';
import * as d3 from "d3";
import * as d3Geo from "d3-geo";
import * as d3Hexbin from "d3-hexbin";
import * as ss from 'simple-statistics';
import * as topojson from 'topojson';

import mapboxgl from 'mapbox-gl';
import { css } from 'glamor'

const mapStyle = css({
  width: '100%',
  height: '90%',
  position: 'absolute'
});

const theMapContainerStyles = css({ 
  height: '100%' 
});

d3.geo = d3Geo;

const coffee = [
  {
    "storenumber": 1004000000,
    "storename": "Allen & Delancey",
    "address": "80 Delancey Street",
    "addressline2": "",
    "addressline3": "",
    "city": "New York",
    "state": "NY",
    "zipcode": "10002-3133",
    "phonenumber": "917 5341397",
    "storehours": "Mon: 06:00:00-22:00:00 Tue: 06:00:00-22:00:00 Wed: 06:00:00-22:00:00 Thu: 06:00:00-22:00:00 Fri: 06:00:00-23:00:00 Sat: 06:00:00-23:00:00 Sun: 06:00:00-22:00:00",
    "wireless": "Wireless Hotspot",
    "latitude": 40.71932,
    "longitude": -73.98995,
    "group": 0,
    "faxnumber": "",
    "drivethru": ""
  },
  {
    "storenumber": 1005000000,
    "storename": "East Northport, Rte. 25",
    "address": "3011 Jericho Tpke.",
    "addressline2": "",
    "addressline3": "",
    "city": "East Northport",
    "state": "NY",
    "zipcode": "11731-6215",
    "phonenumber": "631-499-0258",
    "storehours": "Mon: 05:30:00-22:00:00 Tue: 05:30:00-22:00:00 Wed: 05:30:00-22:00:00 Thu: 05:30:00-22:00:00 Fri: 05:00:00-23:00:00 Sat: 06:30:00-23:30:00 Sun: 06:30:00-22:00:00",
    "wireless": "Wireless Hotspot",
    "latitude": 40.83935,
    "longitude": -73.32388,
    "group": 0,
    "faxnumber": "",
    "drivethru": ""
  },
  {
    "storenumber": 1005000000,
    "storename": "Smith Haven Mall",
    "address": "528 Smith Haven Mall",
    "addressline2": "Smith Haven Mall",
    "addressline3": "",
    "city": "Lake Grove",
    "state": "NY",
    "zipcode": "11755-1206",
    "phonenumber": "631-863-2061",
    "storehours": "Mon: 07:45:00-21:30:00 Tue: 07:45:00-21:30:00 Wed: 07:45:00-21:30:00 Thu: 07:45:00-21:30:00 Fri: 07:45:00-21:30:00 Sat: 07:45:00-21:30:00 Sun: 09:00:00-18:00:00",
    "wireless": "Wireless Hotspot",
    "latitude": 40.86502,
    "longitude": -73.13054,
    "group": 0,
    "faxnumber": "",
    "drivethru": ""
  }
];

class TheMap extends Component {

  constructor() {
    super();
    this.map = null; // This will soon hold reference to our awesome lil map
    this.dots = null; // And this will soon hold reference to dots on the map
    this.svg = null; // You guessed it, will hold ref to the SVG dom elem
  }

  render() {
      return (
      <div {...theMapContainerStyles}>   
          <div id="mapContainer" {...mapStyle}></div>
          <div id="tooltip">
              <svg width="100px" height="100px"></svg>
          </div>
      </div>
      )
  }

  componentDidMount =  () => {
    this.renderTheMap()
    this.setUpD3Viz(this.vzIsSetUp);
  }

  /**
   * Called once the vis is setup
   * Calls to other functions that will 
   * render data, and attach listeners
   */
  vzIsSetUp = () => {
    this.renderTheViz()
    this.attatchRerenderListeners();
  }

  /**
   * Specify's the intial properties of the map, then creates it
   */
  renderTheMap() {
    mapboxgl.accessToken = 'pk.eyJ1IjoiYXN5a2VzIiwiYSI6ImNqajE3cTJkZDBubGMzcW4zZDIydmxnOHcifQ._-KnhpPwutwQ6ZQ3kVa4KQ';    

    this.map = new mapboxgl.Map({
      container: 'mapContainer',
      style: 'mapbox://styles/mapbox/light-v9',
      center: [0, 51.5],
      zoom: 9,
      accessToken: 'pk.eyJ1IjoiYXN5a2VzIiwiYSI6ImNqajE3cTJkZDBubGMzcW4zZDIydmxnOHcifQ._-KnhpPwutwQ6ZQ3kVa4KQ'
    });
  }

  /**
   * TODO - delete this, we'll have real data soon :)
   */
  fakeData() {
    return [
      {
        "lat": 51.475542,
        "lon": -0.038495
      },
      {
        "lat": 51.54907,
        "lon": -0.038173
      },
      {
        "lat": 51.476571,
        "lon": -0.038108
      },
      {
        "lat": 51.487963,
        "lon": -0.037947
      },
      {
        "lat": 51.475435,
        "lon": -0.037937
      },
      {
        "lat": 51.567367,
        "lon": -0.03775
      },
      {
        "lat": 51.527836,
        "lon": -0.03732
      },
      {
        "lat": 51.475188,
        "lon": -0.037175
      },
      {
        "lat": 51.475542,
        "lon": -0.037153
      },
      {
        "lat": 51.475658,
        "lon": -0.037089
      },
      {
        "lat": 51.475803,
        "lon": -0.036778
      },
      {
        "lat": 51.475843,
        "lon": -0.036252
      },
      {
        "lat": 51.545587,
        "lon": -0.036177
      },
      {
        "lat": 51.475653,
        "lon": -0.036123
      },
      {
        "lat": 51.480798,
        "lon": -0.035609
      },
      {
        "lat": 51.506618,
        "lon": -0.03548
      },
      {
        "lat": 51.486106,
        "lon": -0.035372
      },
      {
        "lat": 51.465945,
        "lon": -0.035212
      },
      {
        "lat": 51.47617,
        "lon": -0.035104
      },
      {
        "lat": 51.474587,
        "lon": -0.034943
      },
      {
        "lat": 51.486076,
        "lon": -0.034825
      },
      {
        "lat": 51.477651,
        "lon": -0.034589
      },
      {
        "lat": 51.490428,
        "lon": -0.034364
      },
      {
        "lat": 51.47748,
        "lon": -0.033838
      },
      {
        "lat": 51.508862,
        "lon": -0.033774
      },
      {
        "lat": 51.524585,
        "lon": -0.03376
      },
      {
        "lat": 51.505864,
        "lon": -0.033591
      },
      {
        "lat": 51.48465,
        "lon": -0.033484
      },
      {
        "lat": 51.476017,
        "lon": -0.033388
      },
      {
        "lat": 51.525753,
        "lon": -0.033087
      },
      {
        "lat": 51.505129,
        "lon": -0.032819
      },
      {
        "lat": 51.475663,
        "lon": -0.032722
      },
      {
        "lat": 51.529892,
        "lon": -0.032669
      },
      {
        "lat": 51.501349,
        "lon": -0.032508
      },
      {
        "lat": 51.54921,
        "lon": -0.031896
      },
      {
        "lat": 51.529204,
        "lon": -0.031843
      },
      {
        "lat": 51.483995,
        "lon": -0.03181
      },
      {
        "lat": 51.54504,
        "lon": -0.031156
      },
      {
        "lat": 51.48475,
        "lon": -0.031049
      },
      {
        "lat": 51.551525,
        "lon": -0.03087
      },
      {
        "lat": 51.475462,
        "lon": -0.030663
      },
      {
        "lat": 51.51176,
        "lon": -0.030502
      },
      {
        "lat": 51.525486,
        "lon": -0.030298
      },
      {
        "lat": 51.470965,
        "lon": -0.029944
      },
      {
        "lat": 51.509103,
        "lon": -0.029869
      },
      {
        "lat": 51.53812,
        "lon": -0.029343
      },
      {
        "lat": 51.521579,
        "lon": -0.028524
      },
      {
        "lat": 51.512895,
        "lon": -0.028066
      },
      {
        "lat": 51.536052,
        "lon": -0.02754
      },
      {
        "lat": 51.475141,
        "lon": -0.02732
      },
      {
        "lat": 51.475876,
        "lon": -0.027288
      },
      {
        "lat": 51.526901,
        "lon": -0.026843
      },
      {
        "lat": 51.526901,
        "lon": -0.026843
      },
      {
        "lat": 51.475168,
        "lon": -0.026757
      },
      {
        "lat": 51.538895,
        "lon": -0.026682
      },
      {
        "lat": 51.504244,
        "lon": 0.026682
      },
      {
        "lat": 51.479952,
        "lon": -0.026323
      },
      {
        "lat": 51.478857,
        "lon": -0.026242
      },
      {
        "lat": 51.497248,
        "lon": -0.02621
      },
      {
        "lat": 51.474767,
        "lon": -0.026178
      },
      {
        "lat": 51.478753,
        "lon": -0.026103
      },
      {
        "lat": 51.478733,
        "lon": -0.026087
      },
      {
        "lat": 51.477915,
        "lon": -0.026081
      },
      {
        "lat": 51.476879,
        "lon": -0.026019
      },
      {
        "lat": 51.48019,
        "lon": -0.025936
      },
      {
        "lat": 51.477741,
        "lon": -0.025894
      },
      {
        "lat": 51.477567,
        "lon": -0.025856
      },
      {
        "lat": 51.502745,
        "lon": -0.025684
      },
      {
        "lat": 51.480714,
        "lon": -0.02547
      },
      {
        "lat": 51.526981,
        "lon": -0.025427
      },
      {
        "lat": 51.474734,
        "lon": -0.025389
      },
      {
        "lat": 51.474773,
        "lon": -0.025148
      },
      {
        "lat": 51.485632,
        "lon": -0.025116
      },
      {
        "lat": 51.474694,
        "lon": -0.025022
      },
      {
        "lat": 51.526875,
        "lon": -0.024869
      },
      {
        "lat": 51.479679,
        "lon": -0.024729
      },
      {
        "lat": 51.474557,
        "lon": -0.02459
      },
      {
        "lat": 51.492118,
        "lon": -0.024306
      },
      {
        "lat": 51.527629,
        "lon": -0.024188
      },
      {
        "lat": 51.542535,
        "lon": -0.024118
      },
      {
        "lat": 51.543045,
        "lon": -0.024043
      },
      {
        "lat": 51.474319,
        "lon": -0.023893
      },
      {
        "lat": 51.543078,
        "lon": -0.023823
      },
      {
        "lat": 51.476251,
        "lon": -0.023603
      },
      {
        "lat": 51.527591,
        "lon": -0.02355
      },
      {
        "lat": 51.543702,
        "lon": -0.023362
      },
      {
        "lat": 51.467402,
        "lon": -0.023088
      },
      {
        "lat": 51.542578,
        "lon": -0.022948
      },
      {
        "lat": 51.54464,
        "lon": -0.022877
      },
      {
        "lat": 51.538647,
        "lon": -0.022723
      },
      {
        "lat": 51.541261,
        "lon": -0.022573
      },
      {
        "lat": 51.53124,
        "lon": -0.022348
      },
      {
        "lat": 51.538378,
        "lon": -0.021972
      },
      {
        "lat": 51.534981,
        "lon": -0.021768
      },
      {
        "lat": 51.528296,
        "lon": -0.021682
      },
      {
        "lat": 51.536779,
        "lon": -0.021446
      },
      {
        "lat": 51.536866,
        "lon": -0.021232
      },
      {
        "lat": 51.540153,
        "lon": -0.021092
      },
      {
        "lat": 51.540703,
        "lon": -0.020806
      },
      {
        "lat": 51.538808,
        "lon": -0.020642
      },
      {
        "lat": 51.505,
        "lon": -0.020333
      },
      {
        "lat": 51.539468,
        "lon": -0.020202
      },
      {
        "lat": 51.514705,
        "lon": -0.019735
      },
      {
        "lat": 51.528366,
        "lon": -0.019665
      },
      {
        "lat": 51.528343,
        "lon": -0.019596
      },
      {
        "lat": 51.503666,
        "lon": -0.019333
      },
      {
        "lat": 51.478068,
        "lon": -0.01914
      },
      {
        "lat": 51.48036,
        "lon": -0.019097
      },
      {
        "lat": 51.477978,
        "lon": -0.019086
      },
      {
        "lat": 51.504956,
        "lon": -0.019043
      },
      {
        "lat": 51.502933,
        "lon": -0.018783
      },
      {
        "lat": 51.527482,
        "lon": -0.0187
      },
      {
        "lat": 51.469147,
        "lon": -0.018501
      },
      {
        "lat": 51.480794,
        "lon": -0.018196
      },
      {
        "lat": 51.529711,
        "lon": -0.018078
      },
      {
        "lat": 51.52857,
        "lon": -0.018051
      },
      {
        "lat": 51.48781,
        "lon": -0.017943
      },
      {
        "lat": 51.509837,
        "lon": -0.017595
      },
      {
        "lat": 51.480367,
        "lon": -0.017595
      },
      {
        "lat": 51.484329,
        "lon": 0.017423
      },
      {
        "lat": 51.527329,
        "lon": -0.017359
      },
      {
        "lat": 51.481396,
        "lon": -0.017187
      },
      {
        "lat": 51.528857,
        "lon": -0.017107
      },
      {
        "lat": 51.526674,
        "lon": -0.017021
      },
      {
        "lat": 51.510682,
        "lon": -0.016779
      },
      {
        "lat": 51.486834,
        "lon": 0.016071
      },
      {
        "lat": 51.473163,
        "lon": -0.014784
      },
      {
        "lat": 51.481556,
        "lon": -0.014752
      },
      {
        "lat": 51.523063,
        "lon": -0.014424
      },
      {
        "lat": 51.477935,
        "lon": -0.013271
      },
      {
        "lat": 51.479525,
        "lon": -0.012928
      },
      {
        "lat": 51.484563,
        "lon": 0.012874
      },
      {
        "lat": 51.510825,
        "lon": -0.012767
      },
      {
        "lat": 51.478142,
        "lon": -0.012402
      },
      {
        "lat": 51.516534,
        "lon": -0.011898
      },
      {
        "lat": 51.524271,
        "lon": -0.01127
      },
      {
        "lat": 51.511266,
        "lon": -0.011222
      },
      {
        "lat": 51.480531,
        "lon": -0.010648
      },
      {
        "lat": 51.483895,
        "lon": -0.010643
      },
      {
        "lat": 51.486547,
        "lon": -0.010288
      },
      {
        "lat": 51.509219,
        "lon": -0.010182
      },
      {
        "lat": 51.48316,
        "lon": -0.010063
      },
      {
        "lat": 51.480761,
        "lon": -0.009891
      },
      {
        "lat": 51.489456,
        "lon": -0.009731
      },
      {
        "lat": 51.482906,
        "lon": -0.009655
      },
      {
        "lat": 51.481022,
        "lon": -0.009613
      },
      {
        "lat": 51.481382,
        "lon": -0.009548
      },
      {
        "lat": 51.509663,
        "lon": -0.009527
      },
      {
        "lat": 51.480792,
        "lon": -0.009436
      },
      {
        "lat": 51.482324,
        "lon": -0.009001
      },
      {
        "lat": 51.482324,
        "lon": -0.009001
      },
      {
        "lat": 51.482932,
        "lon": -0.00825
      },
      {
        "lat": 51.527322,
        "lon": -0.007966
      },
      {
        "lat": 51.480353,
        "lon": -0.007531
      },
      {
        "lat": 51.48048,
        "lon": -0.007209
      },
      {
        "lat": 51.52622,
        "lon": -0.007172
      },
      {
        "lat": 51.505967,
        "lon": -0.00693
      },
      {
        "lat": 51.477881,
        "lon": 0.006201
      },
      {
        "lat": 51.483652,
        "lon": -0.005934
      },
      {
        "lat": 51.504731,
        "lon": 0.005855
      },
      {
        "lat": 51.483564,
        "lon": -0.005589
      },
      {
        "lat": 51.483564,
        "lon": -0.005589
      },
      {
        "lat": 51.482839,
        "lon": -0.005493
      },
      {
        "lat": 51.482639,
        "lon": -0.0053
      },
      {
        "lat": 51.474807,
        "lon": 0.005064
      },
      {
        "lat": 51.509363,
        "lon": -0.004645
      },
      {
        "lat": 51.523924,
        "lon": -0.004098
      },
      {
        "lat": 51.475502,
        "lon": -0.003755
      },
      {
        "lat": 51.509376,
        "lon": -0.003529
      },
      {
        "lat": 51.508281,
        "lon": 0.0031
      },
      {
        "lat": 51.510191,
        "lon": -0.002993
      },
      {
        "lat": 51.478062,
        "lon": -0.001668
      },
      {
        "lat": 51.478062,
        "lon": -0.001668
      },
      {
        "lat": 51.478065,
        "lon": -0.001469
      },
      {
        "lat": 51.486848,
        "lon": 0.001427
      },
      {
        "lat": 51.486848,
        "lon": 0.001427
      },
      {
        "lat": 51.477798,
        "lon": -0.001212
      },
      {
        "lat": 51.477674,
        "lon": -0.001158
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5145956,
        "lon": -0.33857
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.51312000000001,
        "lon": -0.127595
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.51043199999999,
        "lon": -0.1299702
      },
      {
        "lat": 51.5155598,
        "lon": -0.1161289
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5117321,
        "lon": -0.1232697
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5149571,
        "lon": -0.1211454
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5185658,
        "lon": -0.1149099
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.515861,
        "lon": -0.129694
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.51508990000001,
        "lon": -0.1336483
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5231081,
        "lon": -0.1292042
      },
      {
        "lat": 51.52150289999999,
        "lon": -0.1203547
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5247339,
        "lon": -0.1369032
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5296213,
        "lon": -0.2012849
      },
      {
        "lat": 51.5232581,
        "lon": -0.1842212
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5289223,
        "lon": -0.2014895
      },
      {
        "lat": 51.56222289999999,
        "lon": -0.1985282
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.4971813,
        "lon": -0.2019931
      },
      {
        "lat": 51.5043483,
        "lon": -0.1975741
      },
      {
        "lat": 51.5202428,
        "lon": -0.1702298
      },
      {
        "lat": 51.5171041,
        "lon": -0.1728799
      },
      {
        "lat": 51.52064799999999,
        "lon": -0.1782033
      },
      {
        "lat": 51.5096281,
        "lon": -0.1703541
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.52111,
        "lon": -0.20104
      },
      {
        "lat": 51.5124887,
        "lon": -0.1824116
      },
      {
        "lat": 51.5148513,
        "lon": -0.1938418
      },
      {
        "lat": 51.51433309999999,
        "lon": -0.1761285
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5157727,
        "lon": -0.1647027
      },
      {
        "lat": 51.51651769999999,
        "lon": -0.1766506
      },
      {
        "lat": 51.5176717,
        "lon": -0.1738984
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5134339,
        "lon": -0.183801
      },
      {
        "lat": 51.5136609,
        "lon": -0.1132125
      },
      {
        "lat": 51.51359249999999,
        "lon": -0.1668292
      },
      {
        "lat": 51.520272,
        "lon": -0.135336
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5161319,
        "lon": -0.1473296
      },
      {
        "lat": 51.5145956,
        "lon": -0.33857
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5134907,
        "lon": -0.1345023
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.538309,
        "lon": -0.2071641
      },
      {
        "lat": 51.5207027,
        "lon": -0.1344628
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5136143,
        "lon": -0.1365486
      },
      {
        "lat": 51.5098192,
        "lon": -0.1310514
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.513481,
        "lon": -0.14655
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5111972,
        "lon": -0.1347663
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5136143,
        "lon": -0.1365486
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5226389,
        "lon": -0.14044
      },
      {
        "lat": 51.5109735,
        "lon": -0.1508328
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5124411,
        "lon": -0.1318767
      },
      {
        "lat": 51.51801400000001,
        "lon": -0.1354301
      },
      {
        "lat": 51.5060812,
        "lon": -0.149544
      },
      {
        "lat": 51.5222916,
        "lon": -0.1387333
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5138699,
        "lon": -0.1396175
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5136143,
        "lon": -0.1365486
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5156031,
        "lon": -0.161764
      },
      {
        "lat": 51.5244218,
        "lon": -0.1664283
      },
      {
        "lat": 51.5192139,
        "lon": -0.144492
      },
      {
        "lat": 51.5107896,
        "lon": -0.1317263
      },
      {
        "lat": 51.518169,
        "lon": -0.1430276
      },
      {
        "lat": 51.5038277,
        "lon": -0.1019775
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.50259759999999,
        "lon": -0.1517873
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.466427,
        "lon": -0.123675
      },
      {
        "lat": 51.4923886,
        "lon": -0.1050748
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.4723055,
        "lon": -0.1220312
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.4697136,
        "lon": -0.1189939
      },
      {
        "lat": 51.4660641,
        "lon": -0.102184
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.4775697,
        "lon": -0.112791
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5353974,
        "lon": -0.1147066
      },
      {
        "lat": 51.478284,
        "lon": -0.1142466
      },
      {
        "lat": 51.4815584,
        "lon": -0.0264139
      },
      {
        "lat": 51.47551540000001,
        "lon": -0.1378307
      },
      {
        "lat": 51.4819076,
        "lon": -0.1251319
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.4716916,
        "lon": -0.1331236
      },
      {
        "lat": 51.47551540000001,
        "lon": -0.1378307
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.49662499999999,
        "lon": -0.1634219
      },
      {
        "lat": 51.4789481,
        "lon": -0.2086299
      },
      {
        "lat": 51.5007732,
        "lon": -0.1781484
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.498034,
        "lon": -0.1799239
      },
      {
        "lat": 51.501382,
        "lon": -0.176053
      },
      {
        "lat": 51.5237433,
        "lon": -0.0668366
      },
      {
        "lat": 51.5010095,
        "lon": -0.1932794
      },
      {
        "lat": 51.5010095,
        "lon": -0.1932794
      },
      {
        "lat": 51.4980918,
        "lon": -0.1814716
      },
      {
        "lat": 51.4978095,
        "lon": -0.1745235
      },
      {
        "lat": 51.4998446,
        "lon": -0.1772095
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5010095,
        "lon": -0.1932794
      },
      {
        "lat": 51.500633,
        "lon": -0.1691499
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.4998069,
        "lon": -0.1691373
      },
      {
        "lat": 51.49671499999999,
        "lon": -0.1763672
      },
      {
        "lat": 51.49432,
        "lon": -0.18263
      },
      {
        "lat": 51.46929979999999,
        "lon": -0.2116285
      },
      {
        "lat": 51.48220569999999,
        "lon": -0.1969622
      },
      {
        "lat": 51.4696946,
        "lon": -0.2101711
      },
      {
        "lat": 51.47906760000001,
        "lon": -0.1920313
      },
      {
        "lat": 51.4667798,
        "lon": -0.2131116
      },
      {
        "lat": 51.480068,
        "lon": -0.189926
      },
      {
        "lat": 51.4806908,
        "lon": -0.2111959
      },
      {
        "lat": 51.4773313,
        "lon": -0.2017231
      },
      {
        "lat": 51.480068,
        "lon": -0.189926
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.4844337,
        "lon": -0.2049439
      },
      {
        "lat": 51.4769525,
        "lon": -0.2096969
      },
      {
        "lat": 51.4788475,
        "lon": -0.1982514
      },
      {
        "lat": 51.4773313,
        "lon": -0.2017231
      },
      {
        "lat": 51.4735744,
        "lon": -0.1993563
      },
      {
        "lat": 51.47949980000001,
        "lon": -0.1990462
      },
      {
        "lat": 51.3912756,
        "lon": -0.2470864
      },
      {
        "lat": 51.4804417,
        "lon": -0.2037237
      },
      {
        "lat": 51.480677,
        "lon": -0.2058802
      },
      {
        "lat": 51.3912756,
        "lon": -0.2470864
      },
      {
        "lat": 51.4811556,
        "lon": -0.1987405
      },
      {
        "lat": 51.480677,
        "lon": -0.2058802
      },
      {
        "lat": 51.480239,
        "lon": -0.1966625
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.48971969999999,
        "lon": -0.189263
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.49034049999999,
        "lon": -0.1958622
      },
      {
        "lat": 51.49375029999999,
        "lon": -0.1943072
      },
      {
        "lat": 51.49211829999999,
        "lon": -0.193179
      },
      {
        "lat": 51.49034049999999,
        "lon": -0.1958622
      },
      {
        "lat": 51.4933169,
        "lon": -0.1921479
      },
      {
        "lat": 51.490643,
        "lon": -0.1887315
      },
      {
        "lat": 51.493726,
        "lon": -0.1932648
      },
      {
        "lat": 51.4904986,
        "lon": -0.1991069
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.48727,
        "lon": -0.19558
      },
      {
        "lat": 51.46231,
        "lon": -0.13857
      },
      {
        "lat": 51.4578309,
        "lon": -0.1481652
      },
      {
        "lat": 51.457819,
        "lon": -0.1427723
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.4621432,
        "lon": -0.1399972
      },
      {
        "lat": 51.48450330000001,
        "lon": -0.1751143
      },
      {
        "lat": 51.4832845,
        "lon": -0.1692853
      },
      {
        "lat": 51.485093,
        "lon": -0.174936
      },
      {
        "lat": 51.485093,
        "lon": -0.174936
      },
      {
        "lat": 51.4846367,
        "lon": -0.1606804
      },
      {
        "lat": 51.4919309,
        "lon": -0.1617253
      },
      {
        "lat": 51.48324119999999,
        "lon": -0.1672116
      },
      {
        "lat": 51.485093,
        "lon": -0.174936
      },
      {
        "lat": 51.485093,
        "lon": -0.174936
      },
      {
        "lat": 51.485093,
        "lon": -0.174936
      },
      {
        "lat": 51.4999574,
        "lon": -0.1635268
      },
      {
        "lat": 51.4946147,
        "lon": -0.1628318
      },
      {
        "lat": 51.4899368,
        "lon": -0.1668178
      },
      {
        "lat": 51.50856779999999,
        "lon": -0.0685133
      },
      {
        "lat": 51.485093,
        "lon": -0.174936
      },
      {
        "lat": 51.4860982,
        "lon": -0.1613697
      },
      {
        "lat": 51.485093,
        "lon": -0.174936
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.4870463,
        "lon": -0.1625369
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.524765,
        "lon": -0.092719
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.4791075,
        "lon": -0.1564981
      },
      {
        "lat": 51.4818232,
        "lon": -0.1443989
      },
      {
        "lat": 51.477992,
        "lon": -0.14823
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.4852999,
        "lon": -0.1911445
      },
      {
        "lat": 51.4891792,
        "lon": -0.1841048
      },
      {
        "lat": 51.4848806,
        "lon": -0.1786719
      },
      {
        "lat": 51.4894353,
        "lon": -0.1819277
      },
      {
        "lat": 51.4879591,
        "lon": -0.1876951
      },
      {
        "lat": 51.4782173,
        "lon": -0.1816507
      },
      {
        "lat": 51.656737,
        "lon": -0.107869
      },
      {
        "lat": 51.479647,
        "lon": -0.1785303
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.485093,
        "lon": -0.174936
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.483365,
        "lon": -0.1765175
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.4997002,
        "lon": -0.1544549
      },
      {
        "lat": 51.5083894,
        "lon": -0.1394816
      },
      {
        "lat": 51.5024597,
        "lon": -0.1348109
      },
      {
        "lat": 51.4572897,
        "lon": -0.205565
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5008748,
        "lon": -0.1223288
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.4939534,
        "lon": -0.1260942
      },
      {
        "lat": 51.4985447,
        "lon": -0.1407959
      },
      {
        "lat": 51.4959119,
        "lon": -0.1476978
      },
      {
        "lat": 51.4998438,
        "lon": -0.1258632
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.4915335,
        "lon": -0.1290035
      },
      {
        "lat": 51.4908194,
        "lon": -0.1528763
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.4952103,
        "lon": -0.1438979
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5354349,
        "lon": -0.1403994
      },
      {
        "lat": 51.5354349,
        "lon": -0.1403994
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.49580899999999,
        "lon": -0.13944
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5230283,
        "lon": -0.124033
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.447222,
        "lon": 0.04805599999999999
      },
      {
        "lat": 51.4781321,
        "lon": -0.0259971
      },
      {
        "lat": 51.466788,
        "lon": -0.066991
      },
      {
        "lat": 51.4815584,
        "lon": -0.0264139
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.4776179,
        "lon": -0.0225955
      },
      {
        "lat": 51.4815584,
        "lon": -0.0264139
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.46939,
        "lon": -0.02269
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.48847749999999,
        "lon": -0.0364349
      },
      {
        "lat": 51.4815584,
        "lon": -0.0264139
      },
      {
        "lat": 51.47530279999999,
        "lon": -0.037763
      },
      {
        "lat": 51.479706,
        "lon": -0.024497
      },
      {
        "lat": 51.4894226,
        "lon": -0.0346273
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.4652843,
        "lon": -0.2597627
      },
      {
        "lat": 51.4815293,
        "lon": -0.1007667
      },
      {
        "lat": 51.475561,
        "lon": -0.0908654
      },
      {
        "lat": 51.47039299999999,
        "lon": -0.0936
      },
      {
        "lat": 51.5966598,
        "lon": -0.1776482
      },
      {
        "lat": 51.474191,
        "lon": -0.06913699999999999
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.4792967,
        "lon": 0.0237645
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5312327,
        "lon": 0.0605822
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      },
      {
        "lat": 51.5073509,
        "lon": -0.1277583
      }
    ]
  }

  getLL = (d) => {
    return mapboxgl.LngLat.convert({lng: +d.lon, lat: +d.lat})
  }

  /**
   * Calculate the scale given mapbox state (derived from viewport-mercator-project's code) 
   * to define a d3 projection
   */
  getMercatorProjection = (d) => {
    // const bbox = document.body.getBoundingClientRect();
    // const center = this.map.getCenter();
    // const zoom = this.map.getZoom();
    // const scale = (512) * 0.5 / Math.PI * Math.pow(2, zoom); // 512 is hard-coded tile size
    // const d3projection = d3.geo.geoMercator()
    //   .center([center.lng, center.lat])
    //   .translate([bbox.width/2, bbox.height/2])
    //   .scale(scale);
    // return d3projection;
    return this.map.project(this.getLL(d));
  }

  /**
   * Renders content based on new data onto the svg layer
   * Note: the viz must already have been set up. Call setUpD3Viz() first. 
   */
  renderTheViz = () => {

    // const d3Projection = this.getMercatorProjection();
    // const path = d3.geo.geoPath()
    // path.projection(d3Projection)

    const data = this.fakeData();
    // const points = topojson.feature(data, data.objects.london_stations)
    const points = data;
    
    this.dots = this.svg
      .selectAll("circle.dot")
      .data(points)

    this.dots.enter()
    .append("circle")
    .classed("dot", true)
    .attr("r", 1)
    .attr("style", "fill: #0082a3; fill-opacity: 0.6; stroke: #004d60; stroke-width: 1")
    .transition()
    .duration(1000)
    .attr("r", 6)
    
    this.dots
    .attr("cx",  (d) => { 
        return this.getMercatorProjection(d).x;
      })
      .attr("cy", (d) => { 
        return this.getMercatorProjection(d).y;
      })
  }

  /**
   * Called once, sets everything up, so that the viz can be rendered
   */

  setUpD3Viz = (doneCb) => {
    // Setup our svg layer to manipulate with d3
    var container = this.map.getCanvasContainer()
    this.svg = d3.select(container)
    .append("svg")
    .attr("class", "map-layer-svg")
   
    // Callback will render the data, and attach the listeners
    doneCb();
  }

  /**
   * Listens for changes in the page or map, 
   * and calls to re-renders the data points
   */
  attatchRerenderListeners = () => {
    this.map.on("viewreset", () => {
      this.renderTheViz()
    })
    this.map.on("move", () => {
      this.renderTheViz()
    })
  }

}

export default TheMap
